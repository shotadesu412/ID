{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-9">
        <h2 class="text-center mb-4">写真で質問→解説</h2>

        <!-- 質問フォーム -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3">質問画像をアップロード</h5>
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="mb-4">
                        <label class="form-label fw-bold me-3">学年を選択：</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="grade" id="grade_middle" value="middle"
                                checked>
                            <label class="form-check-label" for="grade_middle">中学生</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="grade" id="grade_high" value="high">
                            <label class="form-check-label" for="grade_high">高校生</label>
                        </div>
                    </div>

                    <div class="mb-4 border rounded p-3 bg-light text-center" style="border-style: dashed !important;">
                        <input type="file" class="form-control" name="image" accept="image/*" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">送信</button>
                </form>
            </div>
        </div>

        <!-- 履歴 -->
        <h5 class="fw-bold">履歴</h5>
        {% if history %}
        {% for item in history %}
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">{{ item.created_at.strftime('%Y-%m-%d %H:%M') }} | {{ "中学生" if
                    item.grade == "middle" else "高校生" }}</h6>

                {% if item.explanation_status == 'completed' %}
                <div class="mt-3 bg-light p-3 rounded">
                    <pre style="white-space: pre-wrap;" class="mb-0">{{ item.explanation }}</pre>

                    <!-- Re-question UI -->
                    <hr>
                    <div class="mt-3">
                        <label class="form-label fw-bold text-secondary">追加で質問する</label>
                        <div class="input-group">
                            <textarea class="form-control" id="question_text_{{ item.id }}" rows="1"
                                placeholder="解説のここがわかりません..."></textarea>
                            <button class="btn btn-outline-primary" type="button"
                                onclick="sendReQuestion({{ item.id }})">送信</button>
                        </div>
                        <div id="requestion_result_{{ item.id }}" class="mt-2"></div>
                    </div>
                </div>
                {% elif item.explanation_status == 'failed' %}
                <p class="text-danger mt-2">解説の生成に失敗しました: {{ item.explanation }}</p>
                {% else %}
                <p class="text-info mt-2"><i class="spinner-border spinner-border-sm"></i> 解説を作成中...</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p class="text-muted">まだ質問履歴はありません</p>
        {% endif %}

    </div>
</div>

<script>
    async function sendReQuestion(questionId) {
        const textArea = document.getElementById(`question_text_${questionId}`);
        const resultDiv = document.getElementById(`requestion_result_${questionId}`);
        const text = textArea.value.trim();

        if (!text) return;

        // UI Update
        textArea.disabled = true;
        resultDiv.innerHTML = '<span class="text-info"><i class="spinner-border spinner-border-sm"></i> AIが回答を作成中...</span>';

        try {
            const response = await fetch('/api/re-question', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}' // For CSRF protection if enabled
                },
                body: JSON.stringify({
                    question_id: questionId,
                    question_text: text
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Append result
                const answerHtml = `<div class="alert alert-success mt-2"><strong>AI:</strong><br>${data.answer.replace(/\n/g, '<br>')}</div>`;
                resultDiv.innerHTML = answerHtml;
                textArea.value = ''; // Clear input
            } else {
                resultDiv.innerHTML = `<span class="text-danger">エラー: ${data.error || '不明なエラー'}</span>`;
            }
        } catch (e) {
            console.error(e);
            resultDiv.innerHTML = '<span class="text-danger">通信エラーが発生しました</span>';
        } finally {
            textArea.disabled = false;
        }
    }
</script>
{% endblock %}